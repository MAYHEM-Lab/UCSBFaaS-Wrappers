git pull
export PREFIX=/Users/ckrintz/RESEARCH/lambda/

#update the following with your aws account details
#role with admin rights
export ACCT=443592014519
export ROLE=adminlambda
export AWSROLE=arn:aws:iam::${ACCT}:role/${ROLE}
export AWSPROFILE=cjk1
export SPOTBKTWEST=cjktestbkt
export SPOTBKTEAST=cjktestbkteast

cd ${PREFIX}/UCSBFaaS-Wrappers/gammaRay/
deactivate
rm -rf venv
virtualenv venv --python=python3
source venv/bin/activate
pip install fleece
cd venv/lib/python3.6/site-packages/botocore
patch -b < ../../../../../client.patch
cd ${PREFIX}/UCSBFaaS-Wrappers/gammaRay/
cd venv/lib/python3.6/site-packages/fleece
patch -b < ../../../../../xray.patch
cd ${PREFIX}/UCSBFaaS-Wrappers/gammaRay/

#if you want to clean everything out of AWS and start fresh see/run CLEANUP below

#generate the config files for the lambdas for all cases (CASES list is below)
cd ${PREFIX}/UCSBFaaS-Wrappers/gammaRay/
rm -rf configs
mkdir configs
#edit makeConfigs to update triggerBuckets and triggerTables datastructures to have your bucket names
#triggerBuckets for reducerCoordinator must match those in overhead??.sh files and runs below
python makeConfigs.py configs --swbkt ${SPOTBKTWEST} --swbkteast ${SPOTBKTEAST}

#nothing / clean (C)
python setupApps.py -f configs/configC.json -p ${AWSPROFILE} --deleteAll
python setupApps.py -f configs/configC.json -p ${AWSPROFILE} --no_spotwrap 
python setupApps.py -f configs/configCeast.json -p ${AWSPROFILE} --no_spotwrap 
#fleece only (tracing) (T)
python setupApps.py -f configs/configT.json -p ${AWSPROFILE} --deleteAll
python setupApps.py -f configs/configT.json -p ${AWSPROFILE} --no_spotwrap --turn_on_tracing
python setupApps.py -f configs/configTeast.json -p ${AWSPROFILE} --no_spotwrap --turn_on_tracing
#fleece only (tracing+daemon) (F)
python setupApps.py -f configs/configF.json -p ${AWSPROFILE} --deleteAll
python setupApps.py -f configs/configF.json -p ${AWSPROFILE} --no_spotwrap --turn_on_tracing --with_fleece
python setupApps.py -f configs/configFeast.json -p ${AWSPROFILE} --no_spotwrap --turn_on_tracing --with_fleece
#original spotwrap (S)
python setupApps.py -f configs/configS.json -p ${AWSPROFILE} --deleteAll
python setupApps.py -f configs/configS.json -p ${AWSPROFILE} --spotFnsTableName spotFns --spotFnsTableRegion us-west-2
python setupApps.py -f configs/configSeast.json -p ${AWSPROFILE} --spotFnsTableName spotFns --spotFnsTableRegion us-west-2
#fleece only (tracing+daemon) (G)
python setupApps.py -f configs/configG.json -p ${AWSPROFILE} --deleteAll
python setupApps.py -f configs/configG.json -p ${AWSPROFILE} --no_spotwrap --spotFnsTableName gammaRays --spotFnsTableRegion us-west-2 --gammaRay
python setupApps.py -f configs/configGeast.json -p ${AWSPROFILE} --no_spotwrap --spotFnsTableName gammaRays --spotFnsTableRegion us-west-2 --gammaRay

cd ../tools/timings
#clean out the databases gammaRays and spotFns, as well as the logs
./cleanupAWS.sh

#run synchronized map reduce job overhead measurement (default is 100 times)
nohup ./overheadC.sh ${AWSPROFILE} &
nohup ./overheadT.sh ${AWSPROFILE} &
nohup ./overheadF.sh ${AWSPROFILE} &
nohup ./overheadS.sh ${AWSPROFILE} &
nohup ./overheadG.sh ${AWSPROFILE} &

#run microbenchmarks (default is 100 times)


#######  CLEANUP ############
#delete everything in AWS, and I mean everything! run cleanupAWS multiple times to get all database entries
cd ${PREFIX}/tools/timings
#add any other lambdas you want to delete to restConfigsWest.json and restConfigsEast.json
#depending on where your lambdas are
./cleanupAWS.sh ${AWSPROFILE}
./cleanupAWS.sh ${AWSPROFILE}
./cleanupAWS.sh ${AWSPROFILE}
./cleanupAWS.sh ${AWSPROFILE}
./cleanupLambdas.sh ${AWSPROFILE} ${AWSROLE}
======================
CASES:
C - nothing/clean
T - tracing
F - tracing + fleece daemon
S - static spotwrap (original)
G - dynamic spotwrap (gammaray)
